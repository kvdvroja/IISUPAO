<div class="bg-white rounded-t-lg dark:bg-gray-800">
  <div
    class="flex items-center justify-between"
    [ngClass]="{ 'p-4': modo === 'lista' }"
  >
    <div *ngIf="modo === 'lista'" class="relative">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <h2
            class="text-2xl md:text-3xl font-bold bg-gradient-to-r from-blue-600 to-blue-700 dark:text-white bg-clip-text text-transparent"
          >
            SISTEMAS
          </h2>
        </div>
      </div>
      <div
        class="mt-2 h-1 bg-gradient-to-r from-blue-600 to-blue-700 rounded"
      ></div>
    </div>

    <div class="flex items-center gap-2" *ngIf="modo === 'lista'">
      <p-splitButton
        label="Acciones"
        icon="pi pi-cog"
        [model]="accionesDropdown"
        class="p-button-outlined p-button-sm"
      />

      <p-button
        label="Nuevo"
        icon="pi pi-plus"
        class="p-button-sm"
        (click)="modo === 'lista' ? AgregarSistema() : onNuevoEnStepActual()"
      />

      <p-button
        label="Limpiar"
        [outlined]="true"
        icon="pi pi-filter-slash"
        class="p-button-sm"
        (click)="onLimpiar()"
      />

      <p-iconfield iconPosition="left" class="w-64">
        <p-inputicon><i class="pi pi-search"></i></p-inputicon>
        <input
          pInputText
          (input)="onBuscarGlobal($event)"
          placeholder="Buscar..."
          class="w-full"
        />
      </p-iconfield>
    </div>
  </div>

  @if (modo === 'detalle' && selectedSystem) {
  <div>
    <div
      class="relative bg-white/95 backdrop-blur-sm border border-blue-200 rounded-xl shadow-xl overflow-hidden"
    >
      <div class="p-6 md:p-8">
        <div class="flex items-start justify-between gap-4">
          <div class="flex-1">
            <div class="flex items-center gap-4 mb-4">
              <div class="flex items-center gap-3">
                <button
                  pButton
                  type="button"
                  [text]="true"
                  class="absolute h-8 w-8 flex items-center justify-center"
                  (click)="volverALaLista()"
                  title="Volver"
                >
                  <i class="pi pi-chevron-left"></i>
                </button>
                <div
                  class="w-1 md:w-1.5 h-7 md:h-8 bg-gradient-to-b from-blue-600 to-blue-700 rounded-full"
                ></div>
                <h1
                  class="text-2xl md:text-4xl font-bold bg-gradient-to-r from-blue-600 to-blue-700 bg-clip-text text-transparent"
                >
                  {{ selectedSystem.sistema_nombre }}
                </h1>
              </div>

              <span
                class="text-xs md:text-lg px-3 md:px-4 py-1 md:py-2 rounded-lg bg-blue-100 text-blue-800 border border-blue-200 font-mono"
              >
                {{ selectedSystem.sistema_id }}
              </span>
            </div>

            <p
              class="text-base md:text-xl text-gray-700 font-medium mb-4 md:mb-6 leading-relaxed"
            >
              {{ selectedSystem.sistema_descripcion || "—" }}
            </p>
            <div class="flex flex-wrap items-center gap-4 md:gap-6 text-sm">
              <div class="flex items-center gap-2">
                <span
                  class="font-semibold text-gray-600 uppercase tracking-wide"
                  >Estado:</span
                >
                <span
                  class="px-2.5 py-1 rounded-md border font-semibold"
                  [ngClass]="{
                    'bg-green-50 text-green-700 border-green-200':
                      (selectedSystem.sistema_ind_estado || 'A') === 'A',
                    'bg-yellow-50 text-yellow-700 border-yellow-200':
                      (selectedSystem.sistema_ind_estado || 'A') === 'P',
                    'bg-red-50 text-red-700 border-red-200':
                      (selectedSystem.sistema_ind_estado || 'A') === 'I'
                  }"
                >
                  {{ selectedSystem.sistema_ind_estado || "A" }}
                </span>
              </div>

              <div class="flex items-center gap-2">
                <span
                  class="font-semibold text-gray-600 uppercase tracking-wide"
                  >Última Actividad:</span
                >
                <span class="font-medium text-gray-800">
                  {{
                    selectedSystem.sistema_fecha_actividad
                      | date : "dd MMM yyyy, HH:mm"
                  }}
                </span>
              </div>
            </div>
          </div>
          <div class="hidden md:block">
            <div
              class="w-20 h-20 md:w-24 md:h-24 bg-gradient-to-br from-blue-400 to-indigo-500 rounded-2xl opacity-10 rotate-12"
            ></div>
          </div>
        </div>
      </div>
      <div
        class="h-1 bg-gradient-to-r from-blue-500 via-indigo-500 to-blue-600"
      ></div>
    </div>
  </div>
  }

  <!-- ======= CONTENIDO: LISTA O DETALLE ======= -->
  @if (modo === 'lista') {
  <div class="p-2 text-gray-600">
    <!-- Tabla de sistemas -->
    <p-table
      #dt
      [value]="sistemasFiltradas"
      dataKey="sistema_id"
      [rows]="10"
      [rowsPerPageOptions]="[10, 25, 50]"
      [paginator]="true"
      [globalFilterFields]="[
        'sistema_id',
        'sistema_nombre',
        'sistema_descripcion'
      ]"
      tableStyleClass="w-full"
      selectionMode="single"
      [(selection)]="selectedSystem"
      [metaKeySelection]="false"
      (onRowSelect)="onRowSelectedEvent($event)"
      rowHover
    >
      <ng-template #header>
        <tr class="bg-gray-50">
          <th
            class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wide text-gray-500"
          >
            Código
          </th>
          <th
            class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wide text-gray-500"
          >
            Nombre
          </th>
          <th
            class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wide text-gray-500"
          >
            Descripción
          </th>
          <th
            class="px-6 py-3 text-center text-xs font-medium uppercase tracking-wide text-gray-500"
          >
            <div class="flex justify-center">Estado</div>
          </th>
          <th
            class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wide text-gray-500"
          >
            Fecha Actividad
          </th>
          <th
            class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wide text-gray-500"
          >
            Usuario
          </th>
          <th
            class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wide text-gray-500"
          >
            <div class="flex justify-center">Requiere Auth</div>
          </th>
          <th
            class="px-6 py-3 text-center text-xs font-medium uppercase tracking-wide text-gray-500"
          >
            <div class="flex justify-center">Acciones</div>
          </th>
        </tr>
      </ng-template>

      <ng-template #body let-sistema>
        <tr
          [pSelectableRow]="sistema"
          class="border-b hover:bg-gray-50 transition-colors cursor-pointer"
        >
          <td
            class="px-6 py-4 text-sm font-medium text-gray-900 dark:text-white whitespace-nowrap"
          >
            {{ sistema.sistema_id }}
          </td>
          <td
            class="px-6 py-4 text-sm text-gray-900 dark:text-white whitespace-nowrap"
          >
            {{ sistema.sistema_nombre }}
          </td>
          <td class="px-6 py-4 text-sm text-gray-900 dark:text-white">
            <div class="truncate max-w-[40rem]">
              {{ sistema.sistema_descripcion }}
            </div>
          </td>
          <td class="px-6 py-4">
            <div class="flex justify-center">
              <span
                class="estado-badge"
                [ngClass]="
                  (sistema.sistema_ind_estado || '').toUpperCase() === 'A'
                    ? 'estado-a'
                    : 'estado-i'
                "
              >
                {{ sistema.sistema_ind_estado }}
              </span>
            </div>
          </td>
          <td class="px-6 py-4 text-sm text-gray-500 whitespace-nowrap">
            {{ sistema.sistema_fecha_actividad | date : "dd MMM yyyy, HH:mm" }}
          </td>
          <td class="px-6 py-4 text-sm text-gray-900 dark:text-white">
            <div class="truncate max-w-[40rem]">
              {{ sistema.sistema_usua_id }}
            </div>
          </td>
          <td class="px-6 py-4 text-sm text-gray-900 dark:text-white">
            <div class="truncate max-w-[40rem] flex justify-center">
              {{ sistema.sistema_requiere_auth ? "SI" : "NO" }}
            </div>
          </td>
          <td class="px-6 py-4">
            <div class="flex items-center justify-center gap-2">
              <button
                pButton
                type="button"
                [text]="true"
                [rounded]="true"
                [severity]="'secondary'"
                class="btn-icon"
                pTooltip="Editar"
                (click)="$event.stopPropagation(); showEditar(sistema)"
              >
                <i class="pi pi-pencil"></i>
              </button>

              <button
                pButton
                type="button"
                [text]="true"
                [rounded]="true"
                [severity]="'danger'"
                class="btn-icon"
                pTooltip="Eliminar"
                (click)="$event.stopPropagation(); eliminarSistema(sistema)"
              >
                <i class="pi pi-trash"></i>
              </button>
            </div>
          </td>
        </tr>
      </ng-template>

      <ng-template #emptymessage>
        <tr>
          <td colspan="6" class="px-6 py-8 text-center text-sm text-gray-500">
            No se encontraron registros.
          </td>
        </tr>
      </ng-template>
    </p-table>
  </div>
  }

  <!-- DETALLE: render del step actual -->
  @if (modo === 'detalle') {
  <div class="py-2">
    <ng-container [ngSwitch]="currentStep">
      <ng-container *ngSwitchCase="'endpoints'">
        <app-endpoints
          #endpointsCmp
          *ngIf="sistemas?.length"
          [sistemaId]="selectedSystem?.sistema_id || null"
          [sistemasLista]="sistemas"
          (stepNavigate)="onChildNavigate($event)"
          (stepProgress)="onChildProgress($event)"
        ></app-endpoints>
      </ng-container>
    </ng-container>
  </div>
  }
</div>

<!-- ======= Barra de progreso INFERIOR: SOLO EN DETALLE ======= -->
<div
  *ngIf="modo === 'detalle'"
  class="fixed bottom-0 left-0 right-0 bg-white border-t shadow-lg cursor-default"
>
  <div class="max-w-7xl mx-auto px-4 py-4">
    <div class="flex items-center justify-between gap-4">
      <!-- Indicador de pasos -->
      <div class="flex items-center overflow-x-auto gap-3">
        <ng-container *ngFor="let s of steps; let i = index">
          <div class="flex items-center">
            <div
              class="w-8 h-8 rounded-full flex items-center justify-center text-sm font-medium"
              [ngClass]="{
                'bg-blue-600 text-white': i === indicatorIndex,
                'bg-gray-200 text-gray-700': i !== indicatorIndex
              }"
            >
              {{ i + 1 }}
            </div>
            <div class="ml-3">
              <p
                class="text-sm font-medium"
                [ngClass]="{
                  'text-blue-600': i === indicatorIndex,
                  'text-gray-900': i !== indicatorIndex
                }"
              >
                {{ s.title }}
              </p>
            </div>
          </div>
          <div
            *ngIf="i < steps.length - 1"
            class="w-12 h-0.5 mx-2 bg-gray-300"
          ></div>
        </ng-container>
      </div>
    </div>
  </div>
</div>

<!-- Toast + diálogos -->
<p-toast></p-toast>

<p-dialog
  [(visible)]="mostrarDialogoAgregar"
  modal
  [header]="editando ? 'Editar sistema' : 'Agregar nuevo sistema'"
  [style]="{ width: '40rem' }"
  [breakpoints]="{ '960px': '90vw' }"
  [draggable]="false"
  [dismissableMask]="true"
  (visibleChange)="cerrarDialogoAgregar()"
>
  <div class="flex flex-col gap-4">
    @if(editando){
    <p-inputgroup class="shadow-lg">
      <p-inputgroup-addon><i class="pi pi-calendar"></i></p-inputgroup-addon>
      <input
        pInputText
        [(ngModel)]="nuevoSistema.sistema_id"
        placeholder="Id"
        disabled
      />
    </p-inputgroup>
    }

    <p-inputgroup class="shadow-lg">
      <p-inputgroup-addon><i class="pi pi-calendar"></i></p-inputgroup-addon>
      <input
        pInputText
        [(ngModel)]="nuevoSistema.sistema_nombre"
        placeholder="Nombre"
        [disabled]="registroExitoso"
      />
    </p-inputgroup>

    <p-inputgroup class="shadow-lg">
      <p-inputgroup-addon><i class="pi pi-briefcase"></i></p-inputgroup-addon>
      <textarea
        pInputTextarea
        [(ngModel)]="nuevoSistema.sistema_descripcion"
        placeholder="Descripción"
        [disabled]="registroExitoso"
        rows="3"
        class="w-full border border-gray-400 rounded-r p-2 text-gray-600"
      ></textarea>
    </p-inputgroup>

    <p-inputgroup class="">
      <p-inputgroup-addon><i class="pi pi-lock"></i></p-inputgroup-addon>

      <div
        class="flex items-center justify-between w-full px-3 py-2 border border-gray-400 rounded-r"
      >
        <span class="font-medium text-gray-700">¿Requiere autenticación?</span>

        <!-- ToggleSwitch nuevo -->
        <p-toggleSwitch
          [(ngModel)]="nuevoSistema.sistema_requiere_auth"
          [disabled]="registroExitoso"
          inputId="requiere-auth"
        />
        <label for="requiere-auth" class="ml-2 text-sm text-gray-600">
          {{ nuevoSistema.sistema_requiere_auth ? "Sí" : "No" }}
        </label>
      </div>
    </p-inputgroup>

    @if(editando){
    <div class="flex items-center justify-between">
      <span class="text-sm text-gray-600">
        Estado actual:
        <strong>{{ nuevoSistema.sistema_ind_estado || "A" }}</strong>
      </span>

      <p-button
        *ngIf="(nuevoSistema.sistema_ind_estado || 'A') === 'A'"
        label="Desactivar"
        icon="pi pi-ban"
        severity="danger"
        (click)="desactivarSistema(nuevoSistema)"
      ></p-button>
    </div>
    }

    <div class="flex justify-end gap-2 pt-4">
      <p-button
        label="Cancelar"
        icon="pi pi-times"
        (click)="mostrarDialogoAgregar = false"
        outlined
      ></p-button>
      <p-button
        label="Guardar"
        icon="pi pi-check"
        (click)="guardarNuevoSistema()"
        [disabled]="
          !nuevoSistema.sistema_nombre || !nuevoSistema.sistema_descripcion
        "
      ></p-button>
    </div>
  </div>
</p-dialog>

<p-confirmDialog #cd [key]="'sistemas-confirm'">
  <ng-template #headless let-message let-onAccept="onAccept" let-onReject="onReject">
    <div class="flex flex-col items-center p-6 bg-white rounded">
      <i class="pi pi-exclamation-triangle text-orange-500 text-4xl mb-3"></i>
      <div class="text-lg font-semibold mb-2">{{ message.header }}</div>
      <p class="text-center">{{ message.message }}</p>
      <div class="flex justify-center gap-3 mt-4">
        <p-button label="SI" (onClick)="onAccept()" styleClass="w-32"></p-button>
        <p-button label="NO" [outlined]="true" (onClick)="onReject()" styleClass="w-32"></p-button>
      </div>
    </div>
  </ng-template>
</p-confirmDialog>