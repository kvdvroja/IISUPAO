<!-- ======= ENCABEZADO ======= -->
<div class="bg-white rounded-t-lg">
  <div
    class="flex items-center justify-between"
    [ngClass]="{ 'p-4 border-b': modo === 'lista' }"
  >
    <!-- Título y subtítulo dinámicos -->
    <div class="flex items-center gap-2" *ngIf="modo === 'lista'">
      <h2 class="text-xl font-semibold">SISTEMAS</h2>
    </div>

    <!-- Toolbar (igual tanto en lista como en detalle) -->
    <div class="flex items-center gap-2" *ngIf="modo === 'lista'">
      <p-splitButton
        label="Acciones"
        icon="pi pi-cog"
        [model]="accionesDropdown"
        class="p-button-outlined p-button-sm"
      />

      <p-button
        label="Nuevo"
        icon="pi pi-plus"
        class="p-button-sm"
        (click)="modo === 'lista' ? AgregarSistema() : onNuevoEnStepActual()"
      />

      <p-button
        label="Limpiar"
        [outlined]="true"
        icon="pi pi-filter-slash"
        class="p-button-sm"
        (click)="onLimpiar()"
      />

      <p-iconfield iconPosition="left" class="w-64">
        <p-inputicon><i class="pi pi-search"></i></p-inputicon>
        <input
          pInputText
          (input)="onBuscarGlobal($event)"
          placeholder="Buscar..."
          class="w-full"
        />
      </p-iconfield>
    </div>
  </div>

  <!-- ======= TARJETA + PILLS (solo en DETALLE) ======= -->
  @if (modo === 'detalle' && selectedSystem) {
  <div>
    <!-- Tarjeta del sistema -->
    <div class="rounded-lg bg-white shadow-2xl flex flex-row p-4">
      <button
        pButton
        type="button"
        [text]="true"
        class="h-8 w-8 flex items-center justify-center"
        (click)="volverALaLista()"
        title="Volver"
      >
        <i class="pi pi-chevron-left"></i>
      </button>
      <div class="flex flex-col">
        <div class="px-2">
          <div class="flex items-center gap-3 text-xl font-semibold">
            <span class="text-blue-600">{{
              selectedSystem.sistema_nombre
            }}</span>
            <span class="px-2 py-0.5 text-xs rounded-full border text-gray-700">
              {{ selectedSystem.sistema_id }}
            </span>
          </div>

          <p class="mt-1 text-gray-700">
            {{ selectedSystem.sistema_descripcion }}
          </p>
        </div>

        <div class="py-2 px-2 text-sm text-gray-600 flex items-center gap-6">
          <span
            >Estado:
            <span class="px-2 py-0.5 rounded-full border">
              {{ selectedSystem.sistema_ind_estado || "A" }}
            </span>
          </span>
          <span>
            Última Actividad:
            {{
              selectedSystem.sistema_fecha_actividad
                | date : "dd MMM yyyy, HH:mm"
            }}
          </span>
        </div>
      </div>
    </div>

    <!-- Pills / jerarquía (sin cambios) -->
    <div class="rounded-lg my-4 bg-white shadow-2xl">
      <div class="px-4 py-4 flex flex-wrap gap-2">
        <button
          *ngFor="let p of pills"
          type="button"
          (click)="goStep(p.key)"
          class="inline-flex items-center gap-2 rounded-md border border-gray-300 px-3 py-1.5 text-sm cursor-pointer"
          [ngClass]="
            currentStep === p.key
              ? 'bg-black text-white border-transparent'
              : 'bg-white'
          "
        >
          <span>{{ p.icon }}</span>
          {{ p.title }}
        </button>
      </div>
    </div>
  </div>
  }
  
  <!-- ======= CONTENIDO: LISTA O DETALLE ======= -->
  @if (modo === 'lista') {
  <div class="p-2 text-gray-600">
    <!-- Tabla de sistemas -->
    <p-table
      #dt
      [value]="sistemasFiltradas"
      dataKey="sistema_id"
      [rows]="10"
      [rowsPerPageOptions]="[10, 25, 50]"
      [paginator]="true"
      [globalFilterFields]="[
        'sistema_id',
        'sistema_nombre',
        'sistema_descripcion'
      ]"
      tableStyleClass="w-full"
      selectionMode="single"
      [(selection)]="selectedSystem"
      [metaKeySelection]="false"
      (onRowSelect)="onRowSelectedEvent($event)"
      rowHover
    >
      <ng-template #header>
        <tr class="bg-gray-50">
          <th
            class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wide text-gray-500"
          >
            Código
          </th>
          <th
            class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wide text-gray-500"
          >
            Nombre
          </th>
          <th
            class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wide text-gray-500"
          >
            Descripción
          </th>
          <th
            class="px-6 py-3 text-center text-xs font-medium uppercase tracking-wide text-gray-500"
          >
            Estado
          </th>
          <th
            class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wide text-gray-500"
          >
            Fecha Actividad
          </th>
          <th
            class="px-6 py-3 text-center text-xs font-medium uppercase tracking-wide text-gray-500"
          >
            Acciones
          </th>
        </tr>
      </ng-template>

      <ng-template #body let-sistema>
        <tr
          [pSelectableRow]="sistema"
          class="border-b hover:bg-gray-50 transition-colors cursor-pointer"
        >
          <td
            class="px-6 py-4 text-sm font-medium text-gray-900 whitespace-nowrap"
          >
            {{ sistema.sistema_id }}
          </td>
          <td class="px-6 py-4 text-sm text-gray-900 whitespace-nowrap">
            {{ sistema.sistema_nombre }}
          </td>
          <td class="px-6 py-4 text-sm text-gray-900">
            <div class="truncate max-w-[40rem]">
              {{ sistema.sistema_descripcion }}
            </div>
          </td>
          <td class="px-6 py-4">
            <div class="flex justify-center">
              <span
                class="estado-badge"
                [ngClass]="
                  (sistema.sistema_ind_estado || '').toUpperCase() === 'A'
                    ? 'estado-a'
                    : 'estado-i'
                "
              >
                {{ sistema.sistema_ind_estado }}
              </span>
            </div>
          </td>
          <td class="px-6 py-4 text-sm text-gray-500 whitespace-nowrap">
            {{ sistema.sistema_fecha_actividad | date : "dd MMM yyyy, HH:mm" }}
          </td>
          <td class="px-6 py-4">
            <div class="flex items-center justify-center gap-2">
              <button
                pButton
                type="button"
                [text]="true"
                [rounded]="true"
                [severity]="'secondary'"
                class="btn-icon"
                pTooltip="Editar"
                (click)="$event.stopPropagation(); showEditar(sistema)"
              >
                <i class="pi pi-pencil"></i>
              </button>

              <button
                pButton
                type="button"
                [text]="true"
                [rounded]="true"
                [severity]="'info'"
                class="btn-icon"
                pTooltip="Ver Endpoints"
                (click)="$event.stopPropagation(); entrarADetalle(sistema)"
              >
                <i class="pi pi-link"></i>
              </button>

              <button
                pButton
                type="button"
                [text]="true"
                [rounded]="true"
                [severity]="'success'"
                class="btn-icon"
                pTooltip="Agregar Endpoint"
                (click)="
                  $event.stopPropagation();
                  agregarDesdeEndpointsT(sistema.sistema_id)
                "
              >
                <i class="pi pi-plus"></i>
              </button>

              <button
                pButton
                type="button"
                [text]="true"
                [rounded]="true"
                [severity]="'danger'"
                class="btn-icon"
                pTooltip="Eliminar"
                (click)="$event.stopPropagation(); eliminarSistema(sistema)"
              >
                <i class="pi pi-trash"></i>
              </button>
            </div>
          </td>
        </tr>
      </ng-template>

      <ng-template #emptymessage>
        <tr>
          <td colspan="6" class="px-6 py-8 text-center text-sm text-gray-500">
            No se encontraron registros.
          </td>
        </tr>
      </ng-template>
    </p-table>
  </div>
  }

  <!-- DETALLE: render del step actual -->
  @if (modo === 'detalle') {
  <div class="p-2">
    <ng-container [ngSwitch]="currentStep">
      <ng-container *ngSwitchCase="'endpoints'">
        <app-endpoints
          #endpointsCmp
          [sistemaId]="selectedSystem?.sistema_id || null"
          [sistemasLista]="sistemas"
        ></app-endpoints>
      </ng-container>

      <ng-container *ngSwitchCase="'integracion'">
        <app-plantillas [tabFromParent]="'integracion'"></app-plantillas>
      </ng-container>

      <ng-container *ngSwitchCase="'destino'">
        <app-plantilla-destino #pdCmp [sistemasLista]="sistemas">
        </app-plantilla-destino>
      </ng-container>

      <ng-container *ngSwitchCase="'campos'">
        <app-transformacion-campos
          [tabFromParent]="'campos'"
        ></app-transformacion-campos>
      </ng-container>

      <ng-container *ngSwitchCase="'valores'">
        <app-transformacion-campos
          [tabFromParent]="'valores'"
        ></app-transformacion-campos>
      </ng-container>
    </ng-container>
  </div>
  }
</div>

<!-- ======= Barra de progreso INFERIOR: SOLO EN DETALLE ======= -->
<div
  *ngIf="modo === 'detalle'"
  class="fixed bottom-0 left-0 right-0 bg-white border-t shadow-lg"
>
  <div class="max-w-7xl mx-auto px-4 py-4">
    <div class="flex items-center justify-between gap-4">
      <!-- Back / Next -->
      <div class="flex items-center">
        <button
          pButton
          type="button"
          (click)="prevStep()"
          [disabled]="currentIndex === 0"
          label="Back"
          icon="pi pi-chevron-left"
          iconPos="left"
          [severity]="'secondary'"
        ></button>
        <button
          pButton
          type="button"
          (click)="nextStep()"
          [disabled]="currentIndex === steps.length - 1"
        >
          <span class="inline-flex items-center gap-2">
            {{ currentIndex === steps.length - 1 ? "Done" : "Next" }}
            <i
              *ngIf="currentIndex !== steps.length - 1"
              class="pi pi-chevron-right"
            ></i>
          </span>
        </button>
      </div>

      <!-- Indicador de pasos -->
      <div class="flex items-center overflow-x-auto gap-3">
        <ng-container *ngFor="let s of steps; let i = index">
          <div class="flex items-center">
            <div
              class="w-8 h-8 rounded-full flex items-center justify-center text-sm font-medium"
              [ngClass]="{
                'bg-blue-600 text-white': i === currentIndex,
                'bg-gray-200 text-gray-700': i !== currentIndex
              }"
            >
              {{ i + 1 }}
            </div>
            <div class="ml-3">
              <p
                class="text-sm font-medium"
                [ngClass]="{
                  'text-blue-600': i === currentIndex,
                  'text-gray-900': i !== currentIndex
                }"
              >
                {{ s.title }}
              </p>
            </div>
          </div>
          <div
            *ngIf="i < steps.length - 1"
            class="w-12 h-0.5 mx-2 bg-gray-300"
          ></div>
        </ng-container>
      </div>
    </div>
  </div>
</div>

<!-- Toast + diálogos -->
<p-toast></p-toast>

<p-dialog
  [(visible)]="mostrarDialogoAgregar"
  modal
  header="Agregar nuevo sistema"
  [style]="{ width: '40rem' }"
  [breakpoints]="{ '960px': '90vw' }"
  [draggable]="false"
  [dismissableMask]="true"
  (visibleChange)="cerrarDialogoAgregar()"
>
  <div class="flex flex-col gap-4">
    <p-inputgroup class="shadow-lg">
      <p-inputgroup-addon><i class="pi pi-calendar"></i></p-inputgroup-addon>
      <input
        pInputText
        [(ngModel)]="nuevoSistema.sistema_nombre"
        placeholder="Nombre"
        [disabled]="registroExitoso"
      />
    </p-inputgroup>

    <p-inputgroup class="shadow-lg">
      <p-inputgroup-addon><i class="pi pi-briefcase"></i></p-inputgroup-addon>
      <textarea
        pInputTextarea
        [(ngModel)]="nuevoSistema.sistema_descripcion"
        placeholder="Descripción"
        [disabled]="registroExitoso"
        rows="3"
        class="w-full border border-gray-400 rounded-r p-2 text-gray-600"
      ></textarea>
    </p-inputgroup>

    <div class="flex justify-end gap-2 pt-4">
      <p-button
        label="Cancelar"
        icon="pi pi-times"
        (click)="mostrarDialogoAgregar = false"
        outlined
      ></p-button>
      <p-button
        label="Guardar"
        icon="pi pi-check"
        (click)="guardarNuevoSistema()"
        [disabled]="
          !nuevoSistema.sistema_nombre || !nuevoSistema.sistema_descripcion
        "
      ></p-button>
    </div>
  </div>
</p-dialog>

<p-confirmDialog #cd>
  <ng-template
    #headless
    let-message
    let-onAccept="onAccept"
    let-onReject="onReject"
  >
    <div class="flex flex-col items-center p-6 bg-white rounded">
      <i class="pi pi-exclamation-triangle text-orange-500 text-4xl mb-3"></i>
      <div class="text-lg font-semibold mb-2">{{ message.header }}</div>
      <p class="text-center">{{ message.message }}</p>
      <div class="flex justify-center gap-3 mt-4">
        <p-button
          label="SI"
          (onClick)="onAccept()"
          styleClass="w-32"
        ></p-button>
        <p-button
          label="NO"
          [outlined]="true"
          (onClick)="onReject()"
          styleClass="w-32"
        ></p-button>
      </div>
    </div>
  </ng-template>
</p-confirmDialog>

<!-- Endpoints oculto para helpers -->
<app-endpoints
  #endpointsCmp
  [sistemaId]="null"
  [sistemasLista]="sistemas"
  style="display: none"
></app-endpoints>
