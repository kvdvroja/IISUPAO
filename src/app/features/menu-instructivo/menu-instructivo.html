<!-- Lado izquierdo: sidebar -->
<div class="section">
  <app-sidebar [isOpen]="sidebarOpen()"></app-sidebar>
</div>

<!-- Lado derecho: contenido principal -->
<div class="main-content" [class.expanded]="!sidebarOpen()">
  <app-navbar
    [isSidebarOpen]="sidebarOpen()"
    (sidebarToggle)="toggleSidebar()"
  ></app-navbar>

  <!-- Encabezado -->
  <div
    class="mx-auto max-w-8xl px-3 md:px-6 pt-4 border-b-2 border-gray-200 pb-2"
  >
    <div class="mb-4">
      <h1 class="text-2xl font-bold tracking-tight">MENÚ INSTRUCTIVO</h1>
      <p class="text-muted-foreground">
        Navega de forma guiada por las secciones para configurar sistemas,
        endpoints y plantillas, así como transformar campos y valores.
      </p>
    </div>

    <!-- Menú de pasos (versión refinada) -->
    <div class="w-full">
      <nav
        aria-label="Instruction steps"
        class="relative rounded-xl border"
        [ngClass]="
          variant === 'elevated'
            ? 'bg-gradient-to-br from-foreground/[0.02] via-background to-background shadow-sm'
            : 'bg-background'
        "
      >
        <!-- Steps -->
        <ol
          role="list"
          class="flex snap-x snap-mandatory items-stretch gap-2 overflow-x-auto p-2 md:gap-3 md:p-3 justify-center"
        >
          @for (step of steps; track $index) {
          <li class="flex items-center snap-start">
            <button
              type="button"
              (click)="setActive($index)"
              [disabled]="step.disabled"
              [attr.aria-current]="$index === active() ? 'step' : null"
              pTooltip="{{ step.description || '' }}"
              tooltipPosition="bottom"
              class="group relative flex items-center gap-2 rounded-full border transition-all whitespace-nowrap"
              [ngClass]="[
                padClass,
                textClass,
                buttonStateClass($index, !!step.disabled),
                step.disabled ? 'cursor-not-allowed opacity-50' : ''
              ]"
            >
              <span
                class="relative flex size-6 items-center justify-center rounded-full transition-colors"
                [ngClass]="badgeStateClass($index, !!step.disabled)"
                aria-hidden="true"
              >
                @if (step.disabled) {
                <i class="pi pi-lock text-xs"></i>
                } @else if ($index < active()) {
                <i class="pi pi-check text-xs"></i>
                } @else {
                <i [ngClass]="iconClass(step.id)" class="text-xs"></i>
                }
              </span>

              <span class="font-medium tracking-wide">
                {{ step.title }}
              </span>
            </button>
          </li>
          }
        </ol>

        <!-- Progress bar -->
        <div class="relative h-2">
          <div
            class="absolute inset-x-3 bottom-0 top-0 rounded-full bg-muted/70 md:inset-x-4"
          ></div>
          <div
            class="absolute bottom-0 top-0 left-3 md:left-4 rounded-full bg-gradient-to-r from-emerald-500 to-fuchsia-500 transition-all duration-300"
            [ngStyle]="{ width: progressWidthCalc }"
            aria-hidden="true"
          ></div>
        </div>
      </nav>

      <!-- Controles -->
      @if (showControls) {
      <div
        class="mt-4 flex flex-col items-stretch justify-between gap-3 sm:flex-row sm:items-center"
      >
        <div class="order-2 flex items-center gap-2 sm:order-1">
          <button
            pButton
            type="button"
            (click)="prev()"
            [disabled]="active() === 0"
            class="min-w-28"
            label="Back"
            icon="pi pi-chevron-left"
            iconPos="left"
            [severity]="'secondary'"
          ></button>

          <button
            pButton
            type="button"
            (click)="next()"
            [disabled]="active() === steps.length - 1"
            class="min-w-28"
          >
            <span class="inline-flex items-center gap-2">
              {{ active() === steps.length - 1 ? "Done" : "Next" }}
              @if (active() !== steps.length - 1) {
              <i class="pi pi-chevron-right"></i>
              }
            </span>
          </button>
        </div>

        <div
          class="order-1 flex items-center justify-between sm:order-2 sm:justify-end"
        >
          <div class="text-sm font-medium">
            Step {{ active() + 1 }} of {{ steps.length }}
            <span
              class="ml-2 rounded-full bg-foreground/5 px-2 py-0.5 text-xs text-muted-foreground"
            >
              {{ progressPct }}% complete
            </span>
          </div>
        </div>
      </div>
      }
    </div>
  </div>
  <!-- Contenido por paso -->
  <div class="mt-6 px-3 md:px-6 pb-6">
    @switch (steps[active()].id) { @case ('SISTEMAS') {
    <app-sistemas
      [tabFromParent]="'systems'"
      (stepNavigate)="onStepNavigate($event)"
      (stepProgress)="onStepProgress($event)"
    />
    } @case ('endpoints') {
    <app-sistemas
      [tabFromParent]="'endpoints'"
      (stepNavigate)="onStepNavigate($event)"
      (stepProgress)="onStepProgress($event)"
    />
    } @case ('PLANTILLA_INTEGRACION') {
    <app-plantillas
      [tabFromParent]="'integracion'"
      (stepNavigate)="onStepNavigate($event)"
      (stepProgress)="onStepProgress($event)"
    />
    } @case ('PLANTILLA_DESTINO') {
    <app-plantillas
      [tabFromParent]="'destino'"
      (stepNavigate)="onStepNavigate($event)"
      (stepProgress)="onStepProgress($event)"
    />
    } @case ('TRANSFORMACION_CAMPOS') {
    <app-transformacion-campos
      [tabFromParent]="'campos'"
      (stepNavigate)="onStepNavigate($event)"
      (stepProgress)="onStepProgress($event)"
    >
    </app-transformacion-campos>
    } @case ('TRANSFORMACION_VALORES'){
    <app-transformacion-campos
      [tabFromParent]="'valores'"
      (stepNavigate)="onStepNavigate($event)"
      (stepProgress)="onStepProgress($event)"
    >
    </app-transformacion-campos>
    } @default {
    <div class="rounded-xl border bg-background p-4">Selecciona un paso.</div>
    } }
  </div>
</div>
